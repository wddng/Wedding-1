<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Scanner Buku Tamu</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/html5-qrcode"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<style>
body{
  font-family:Arial, sans-serif;
  text-align:center;
  padding:16px;
}
#reader{
  width:300px;
  margin:auto;
}
#status{
  margin-top:14px;
  font-size:15px;
}
.success{color:green}
.error{color:red}
</style>
</head>
<body>

<h3>ðŸ“¸ Scan QR Tamu</h3>
<div id="reader"></div>
<div id="status">Arahkan kamera ke QR</div>

<script>
/* ================= FIREBASE INIT ================= */
firebase.initializeApp({
  apiKey: "AIzaSyAbFiLWZS5H1672SpouCn1deEAAn4qVqDs",
  databaseURL: "https://undanganwidi-default-rtdb.asia-southeast1.firebasedatabase.app"
});
const db = firebase.database();

/* ================= SCANNER ================= */
let qr;

function startScan(){
  Html5Qrcode.getCameras().then(cameras => {
    if(!cameras.length){
      alert("Kamera tidak ditemukan");
      return;
    }

    const cameraId = cameras[cameras.length - 1].id; // kamera belakang
    qr = new Html5Qrcode("reader");

    qr.start(
      cameraId,
      { fps:8, qrbox:{width:220,height:220} },
      onScanSuccess,
      err => {}
    );
  });
}

function onScanSuccess(text){
  qr.stop(); // stop biar tidak dobel scan

  // FORMAT QR: id|nama
  const data = text.split("|");
  if(data.length < 2){
    document.getElementById("status").innerHTML =
      "<span class='error'>QR tidak valid</span>";
    setTimeout(startScan, 2000);
    return;
  }

  const id   = data[0];
  const nama = data[1];

  const ref = db.ref("bukutamu/" + id);

  ref.once("value").then(snap=>{
    if(snap.exists()){
      // sudah ada â†’ update hadir
      ref.update({
        status: "Hadir",
        waktuHadir: Date.now()
      });

      document.getElementById("status").innerHTML =
        "<span class='success'>âœ… "+nama+" sudah hadir</span>";
    }else{
      // tamu baru
      ref.set({
        nama: nama,
        status: "Hadir",
        pesan: "",
        waktuHadir: Date.now(),
        like: 0
      });

      document.getElementById("status").innerHTML =
        "<span class='success'>ðŸŽ‰ "+nama+" berhasil check-in</span>";
    }

    // scan ulang setelah 2 detik
    setTimeout(startScan, 2000);
  });
}

window.addEventListener("load", startScan);
</script>

</body>
</html>
